# 爬虫

### 常用的模块

#### Urllib库

request

```
import urllib.request
 
response = urllib.request.urlopen('http://www.baidu.com')
print(response.read().decode('utf-8'))
```

 request 模块中的 Request 除了定义 url 和 data 之外，还可以定义请求头信息

```

from urllib import request,parse
import ssl
context = ssl._create_unverified_context()
url = 'https://biihu.cc//account/ajax/login_process/'
headers = {
    #假装自己是浏览器
    'User-Agent':' Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36',
}

dict = {
    'return_url':'https://biihu.cc/',
    'user_name':'xiaoshuaib@gmail.com',
    'password':'123456789',
    '_post_type':'ajax',
}
data = bytes(parse.urlencode(dict),'utf-8')
然后可以封装 request
req = request.Request(url,data=data,headers=headers,method='POST')
最后我们进行请求
response = request.urlopen(req,context=context)
print(response.read().decode('utf-8'))
```

error

parse

robotparser

#### **Requests**库

pip install requests

```
import requests
r = requests.get('https://api.github.com/events')

```

#### BeautifulSoup库

pip install beautifulsoup4

```

html_doc = """

<html><head><title>学习python的正确姿势</title></head>
<body>
<p class="title"><b>小帅b的故事</b></p>

<p class="story">有一天，小帅b想给大家讲两个笑话
<a href="http://example.com/1" class="sister" id="link1">一个笑话长</a>,
<a href="http://example.com/2" class="sister" id="link2">一个笑话短</a> ,
他问大家，想听长的还是短的？</p>

<p class="story">...</p>

"""

soup = BeautifulSoup(html_doc,'lxml')
print(soup.title.string)
#学习python的正确姿势
print(soup.p.string)
#小帅b的故事
print(soup.find(id="link2"))
#<a class="sister" href="http://example.com/2" id="link2">一个笑话短</a>

soup = BeautifulSoup(html_doc,'lxml')

print(soup.select("title"))
print(soup.select("body a"))
print(soup.select("p > #link1"))
```

https://www.crummy.com/software/BeautifulSoup/bs4/doc/

#### selenium库 +phantomJS浏览器

#### json模块

```
json.dumps()将python对象转化为json是这样的
json.loads()将json数据转化为python对象是这样的
```



### 正则表达式

|    \d    | 代表任意数字，就是阿拉伯数字 0-9 这些玩意。                  |
| :------: | ------------------------------------------------------------ |
|   `\D`   | 大写的就是和小写的唱反调，\d 你代表的是任意数字是吧？那么我 \D 就代表不是数字的。 |
|   `\w`   | 代表字母，数字，下划线。也就是 a-z、A-Z、0-9、_。            |
|   `\W`   | 跟 \w 唱反调，代表不是字母，不是数字，不是下划线的。         |
|    \n    | 代表一个换行。                                               |
|   `\r`   | 代表一个回车。                                               |
|   `\f`   | 代表换页。                                                   |
|   `\t`   | 代表一个 Tab 。                                              |
|   `\s`   | 代表所有的空白字符，也就是上面这个：\n、\r、\t、\f。         |
|   `\S`   | 跟 \s 唱反调，代表所有不是空白的字符。                       |
|   `\A`   | 代表字符串的开始。                                           |
|   `\Z`   | 代表字符串的结束。                                           |
|    ^     | 匹配字符串开始的位置。                                       |
|    $     | 匹配字符创结束的位置。                                       |
|    .     | 代表所有的单个字符，除了 \n \r                               |
| `[...]`  | 代表在 [] 范围内的字符，比如 [a-z] 就代表 a到z的字母         |
| `[^...]` | 跟 [...] 唱反调，代表不在 [] 范围内的字符                    |
|   {n}    | 匹配在 {n} 前面的东西，比如: o{2} 不能匹配 Bob 中的 o ，但是能匹配 food 中的两个o。 |
| `{n,m}`  | 匹配在 {n,m} 前面的东西，比如：o{1,3} 将匹配“fooooood”中的前三个o。 |
| `{n，}`  | 匹配在 {n,} 前面的东西，比如：o{2,} 不能匹配“Bob”中的“o”，但能匹配“foooood”中的所有o。 |
|   `*`    | 和 {0,} 一个样，匹配 * 前面的 0 次或多次。 比如 zo* 能匹配“z”、“zo”以及“zoo”。 |
|   `+`    | 和{1，} 一个样，匹配 + 前面 1 次或多次。 比如 zo+”能匹配“zo”以及“zoo”，但不能匹配“z”。 |
|   `？`   | 和{0,1} 一个样，匹配 ？前面 0 次或 1 次。                    |
|   a\|b   | 匹配 a 或者 b。                                              |
|  `（）`  | 匹配括号里面的内容。                                         |

#### re 模块

```
import re
贪婪匹配
content = 'Xiaoshuaib has 100 bananas'
res = re.match('^Xi.*(\d+)\s.*s$',content)
print(res.group(1))


import re
非贪婪匹配
content = 'Xiaoshuaib has 100 bananas'
res = re.match('^Xi.*?(\d+)\s.*s$',content)
print(res.group(1))
```

 re 的匹配模式

 re.S可匹配换行的     

```
import re

content = """Xiaoshuaib has 100 
bananas"""
res = re.match('^Xi.*?(\d+)\s.*s$',content,re.S)
print(res.group(1))
```

  **re.search**会直接去扫描字符串

```
import re

content = """Xiaoshuaib has 100 
bananas"""
res = re.search('Xi.*?(\d+)\s.*s',content,re.S)
print(res.group(1))
```

**re.findall**

```

import re

content = """Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;"""
res = re.findall('Xi.*?(\d+)\s.*?s;',content,re.S)
print(res)
```

**re.sub**替换

```

import re

content = """Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;
Xiaoshuaib has 100 bananas;"""
content = re.sub('\d+','250',content)
print(content)
```

**re.compile**

```
import re

content = "Xiaoshuaib has 100 bananas"
pattern = re.compile('Xi.*?(\d+)\s.*s',re.S)
res = re.match(pattern,content)

print(res.group(1))
```



### 反爬机制

代理地址：IP代理池，通过 python 程序去抓取网上大量免费的代理 ip

#### 当爬取的网站需要登陆

##### Cookie大法

每一个使用这个网站的人， 服务器都会给他一个 Cookie，Cookie 的时长周期是服务器那边定的

```

import requests

headers = {
    # 假装自己是浏览器
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/73.0.3683.75 Chrome/73.0.3683.75 Safari/537.36',
    # 把你刚刚拿到的Cookie塞进来
    'Cookie': 'eda38d470a662ef3606390ac3b84b86f9; Hm_lvt_f1d3b035c559e31c390733e79e080736=1553503899; biihu__user_login=omvZVatKKSlcXbJGmXXew9BmqediJ4lzNoYGzLQjTR%2Fjw1wOz3o4lIacanmcNncX1PsRne5tXpE9r1sqrkdhAYQrugGVfaBICYp8BAQ7yBKnMpAwicq7pZgQ2pg38ZzFyEZVUvOvFHYj3cChZFEWqQ%3D%3D; Hm_lpvt_f1d3b035c559e31c390733e79e080736=1553505597',
}

session = requests.Session()
response = session.get('https://biihu.cc/people/wistbean%E7%9C%9F%E7%89%B9%E4%B9%88%E5%B8%85', headers=headers)

print(response.text)
```

##### 表单请求大法

通过抓包，获取请求登录的时候需要用到的用户名密码参数，然后以表单的形式请求服务器

##### Selenium 自动登录法

获取到两个输入框的元素，再获取到登录按钮，往输入框写你的帐号密码，然后自动点击一下登录

```

username = WAIT.until(EC.presence_of_element_located((By.CSS_SELECTOR, "帐号的selector")))
password = WAIT.until(EC.presence_of_element_located((By.CSS_SELECTOR, "密码的selector")))
submit = WAIT.until(EC.element_to_be_clickable((By.XPATH, '按钮的xpath')))

username.send_keys('你的帐号')
password.send_keys('你的密码')
submit.click()
```

登录完之后拿到 Cookie

```

cookies = webdriver.get_cookies()
```

#### 当需要验证码

##### 图像验证码

首先要处理一下验证码图片，什么噪点乱七八糟的，我们尽量把它们去掉，然后再用 python 强大的 OCR 工具，Python-tesseract来识别我们优化好的图片

pytesseract 是没办法识别太多噪点的图片的，如果这个图片再加上一点彩色背景，那么对 pytesseract 来说更是有点吃力的

```
灰度处理
captcha = Image.open("captcha2.png")
result = captcha.convert('L')
result.show()
二值化

def convert_img(img,threshold):
    img = img.convert("L")  # 处理灰度
    pixels = img.load()
    for x in range(img.width):
        for y in range(img.height):
            if pixels[x, y] > threshold:
                pixels[x, y] = 255
            else:
                pixels[x, y] = 0
    return img

convert_img(captcha,150)
```

接下来我们再来看看有毛有噪的图片，先处理灰度，再 二值化，这次我们再降一下噪

```

data = img.getdata()
    w,h = img.size
    count = 0
    for x in range(1,h-1):
        for y in range(1, h - 1):
            # 找出各个像素方向
            mid_pixel = data[w * y + x]
            if mid_pixel == 0:
                top_pixel = data[w * (y - 1) + x]
                left_pixel = data[w * y + (x - 1)]
                down_pixel = data[w * (y + 1) + x]
                right_pixel = data[w * y + (x + 1)]

                if top_pixel == 0:
                    count += 1
                if left_pixel == 0:
                    count += 1
                if down_pixel == 0:
                    count += 1
                if right_pixel == 0:
                    count += 1
                if count > 4:
                    img.putpixel((x, y), 0)
```

对于一些简单的验证码，使用 pytesseract 还是可以的，如果你想提高 pytesseract 识别率还可以去搞些图片去训练一下 tesseract-ocr

##### 滑动验证码

##### 语音验证

##### 短信验证

##### 点击验证

#### css加密

**加密自定义字体**

#### js加密

简单点的 JS 加密函数，可以使用 Python 模拟相关的函数

比如我们玩过的那个，有道词典的，就是模拟 hash 的加密函数

可以使用 Python 运行 JS 

**js2py**  **PyV8**   **PyExecJS**

### 数据存储

#### 文本文件

#### redis

#### 数据库

##### mysql

pip install pymysql

```
import pymysql
# 使用 connect 方法，传入数据库地址，账号密码，数据库名就可以得到你的数据库对象
db = pymysql.connect(host="localhost", user="root", password="henu", db="avIdol")

# 接着我们获取 cursor 来操作我们的 avIdol 这个数据库
cursor = db.cursor()

# # 比如我们来创建一张数据表
# sql = """create table beautyGirls (
#    name char(20) not null,
#    age int)"""
# cursor.execute(sql)

# 插入一条记录
sql = "insert into beautyGirls(name, age) values ('Mrs.cang', 18)"

try:
    cursor.execute(sql)
    db.commit()
except:
    # 回滚
    db.rollback()
# 最后我们关闭这个数据库的连接
db.close()
```

```

import pandas as pd
from sqlalchemy import create_engine

df = pd.read_csv('xsb.csv')

# 当engine连接的时候我们就插入数据
engine = create_engine('mysql://root@localhost/xsb?charset=utf8')
with engine.connect() as conn, conn.begin():
    df.to_sql('xsb', conn, if_exists='replace')
```

##### MongoDB(非关系型数据库)



#### CSV

支持存储比较大量的数据

方便地利用它进行数据的导入或者导出到电子表格或者数据库

所有支持文本文件的输入输出的编程语言（比如我们的 python），都可以直接操作使用 CSV 文件

```

import csv

with open('xiaoshuaib.csv', mode='w') as csv_file:
    fieldnames = ['你是谁', '你几岁', '你多高']
    writer = csv.DictWriter(csv_file, fieldnames=fieldnames)

    writer.writeheader()
    writer.writerow({'你是谁': '小帅b', '你几岁': '18岁', '你多高': '18cm'})
    writer.writerow({'你是谁': '小帅c', '你几岁': '19岁', '你多高': '17cm'})
    writer.writerow({'你是谁': '小帅d', '你几岁': '20岁', '你多高': '16cm'})
```

```

import pandas as pd

b = ['小帅b', '小帅c', '小帅d']
c = ['18岁', '19岁', '20岁']
d = ['18cm', '17cm', '16cm']

df = pd.DataFrame({'你是谁' : b, '你几岁' : c, '你多高' : d})
df.to_csv("xsb.csv", index=False, sep=',')
```



### 爬虫效率

进程>线程

并行，在某一个时间段同时执行多个进程

并发，在一个时间点同时执行多个进程

进程之间相互独立，一个进程里的多个线程共享一个进程空间，线程在争着，数据不安全，于是有了互斥锁

处理多任务就开启多进程

输入输出的多任务就开启多线程，GIL锁用来控制线程执行权限，在I/O流阻塞的时候，GIL会被释放

协程（微线程）根据需要自己调度，线程和进程通过系统调度

```
 使用 Process 这个类来创建进程
from multiprocessing import Process

def f(name):
    print('hello', name)

if __name__ == '__main__':
    p = Process(target=f, args=('xiaoshuaib',))
    p.start()
    p.join()
    还可以使用进程池的方式
from multiprocessing import Pool

def f(x):
    return x*x

if __name__ == '__main__':
    with Pool(5) as p:
        print(p.map(f, [1, 2, 3]))
```

连手机调试

![image-20240716211849223](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240716211849223.png)

```
adb shell dumpsys window | findstr mCurrentFocus
 
 mCurrentFocus=Window{d53764b u0 com.tencent.mm/com.tencent.mm.ui.LauncherUI}
```



```
 desired_caps = {}
   desired_caps['platformName'] = 'Android'
   desired_caps['platformVersion'] = '14'
   desired_caps['deviceName'] = 'QOCUIZXSTWCMQSZD   '
   desired_caps['appPackage'] = 'com.tencent.mm'
   desired_caps['appActivity'] = '.ui.LauncherUI'
   
   
   # 获取密码元素并输入
 password = self.wait.until(EC.presence_of_element_located((By.XPATH,  '//*[@resource-id="com.tencent.mm:id/d98"]/android.widget.EditText')))
 password.send_keys("你的微信密码")
 # 登录
 login = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/iol")))
 login.click()
 
 
 # 获取到搜索按钮后点击
 search_btn = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/meb")))
 search_btn.click()
 
 
# 获取搜索框并输入
search_input = self.wait.until(EC.presence_of_element_located((By.ID, "com.tencent.mm:id/d98")))
search_input.send_keys("你好，请说")


# 点击头像进入
 xiaoshuaib_btn = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/a_4")))
 xiaoshuaib_btn.click()
 
 
# 点击右上角...进入
menu_btn = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/fq")))
menu_btn.click()
# 再点击头像
icon_btn = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/m7e")))
icon_btn.click()
# 点击朋友圈
moment_btn = self.wait.until(EC.element_to_be_clickable((By.ID, "com.tencent.mm:id/rt")))
moment_btn.click()


# 获取 FrameLayout
 items = self.wait.until(EC.presence_of_all_elements_located((By.ID, 'com.tencent.mm:id/nah')))
 # 滑动
 self.driver.swipe(self.start_x, self.start_y, self.end_x, self.end_y, 2000)
 #遍历获取
 for item in items:
     moment_text = item.find_element_by_id('com.tencent.mm:id/n9w').text
     day_text = item.find_element_by_id('com.tencent.mm:id/n7u').text
     month_text = item.find_element_by_id('com.tencent.mm:id/n_7').text
     print('抓取到小帅b朋友圈数据： %s' % moment_text)
     print('抓取到小帅b发布时间： %s%s' % (month_text, day_text))
```



#### threading模块

#### Quene模块

### 爬虫框架

#### scrapy

在你想要存放的爬虫文件目录下，使用命令来创建一个 scrapy 爬虫项目

```
scrapy startproject qiushibaike
```

![image-20240717180813339](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717180813339.png)

spiders 目录：用来存放我们写爬虫文件的地方

items.py：用来定义我们要存储数据的字段

middlewares.py：中间件，在这里面可以做一些在爬虫过程中想干的事情，比如爬虫在响应的时候你可以做一些操作

pipelines.py：这是我们用来定义一些存储信息的文件，比如我们要连接 MySQL或者 MongoDB 就可以在这里定义

settings.py：这个文件用来定义我们的各种配置，比如配置请求头信息等

运行

```
 cd qiushibaike/
 scrapy crawl qiushibaike
```

scrapy 还内置了很多好用的命令

```

scrapy shell /home/wistbean/PycharmProjects/spider/qiushibaike/qiushi-1.html
```

```
def parse(self, response):

        content_left_div = response.xpath('//*[@id="content-left"]')
        content_list_div = content_left_div.xpath('./div')

        for content_div in content_list_div:
            yield {
                'author': content_div.xpath('./div/a[2]/h2/text()').get(),
                'content': content_div.xpath('./a/div/span/text()').getall(),
            }
```

使用命令行

```
scrapy crawl qiushibaike
```

要将爬下来的数据存储为 json 文件

```

scrapy crawl qiushibaike -o qiushibaike.json
在 settings.py 中加一句

FEED_EXPORT_ENCODING = 'utf-8'
```



### 数据可视化

#### matplotlib

##### 正弦

```
import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-np.pi, np.pi, 256)

cos = np.cos(x)
sin = np.sin(x)

plt.plot(x, cos, '--', linewidth=2)
plt.plot(x, sin)

plt.show()
```

![image-20240717165741353](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717165741353.png)

##### 饼图

```

# Pie chart, where the slices will be ordered and plotted counter-clockwise:
labels = 'Frogs', 'Hogs', 'Dogs', 'Logs'
sizes = [15, 30, 45, 10]
explode = (0, 0.1, 0, 0)  # only "explode" the 2nd slice (i.e. 'Hogs')

fig1, ax1 = plt.subplots()
ax1.pie(sizes, explode=explode, labels=labels, autopct='%1.1f%%',
        shadow=True, startangle=90)
ax1.axis('equal')  # Equal aspect ratio ensures that pie is drawn as a circle.

plt.show()
```

![image-20240717165806247](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717165806247.png)

##### 直方图

```

import numpy as np
import matplotlib.pyplot as plt

np.random.seed(0)

mu = 200
sigma = 25
x = np.random.normal(mu, sigma, size=100)

fig, (ax0, ax1) = plt.subplots(ncols=2, figsize=(8, 4))

ax0.hist(x, 20, normed=1, histtype='stepfilled', facecolor='g', alpha=0.75)
ax0.set_title('stepfilled')

# Create a histogram by providing the bin edges (unequally spaced).
bins = [100, 150, 180, 195, 205, 220, 250, 300]
ax1.hist(x, bins, normed=1, histtype='bar', rwidth=0.8)
ax1.set_title('unequal bins')

fig.tight_layout()
plt.show()
```

![image-20240717165926182](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717165926182.png)

#### seaborn

##### 散点图

```

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
sns.set(style="darkgrid")


tips = sns.load_dataset("tips")
sns.relplot(x="total_bill", y="tip", data=tips);
plt.show()
```

![image-20240717170156476](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717170156476.png)

##### 折线图

```

fmri = sns.load_dataset("fmri")
sns.relplot(x="timepoint", y="signal", hue="event", kind="line", data=fmri);
plt.show()
```

![image-20240717170227885](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717170227885.png)

##### 直方图

```


titanic = sns.load_dataset("titanic")
sns.catplot(x="sex", y="survived", hue="class", kind="bar", data=titanic);
plt.show()
```

![image-20240717170252334](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717170252334.png)

#### pyecharts

```

from pyecharts.charts import Bar
from pyecharts import options as opts

bar = (
    Bar()
    .add_xaxis(["衬衫", "毛衣", "领带", "裤子", "风衣", "高跟鞋", "袜子"])
    .add_yaxis("商家A", [114, 55, 27, 101, 125, 27, 105])
    .add_yaxis("商家B", [57, 134, 137, 129, 145, 60, 49])
    .set_global_opts(title_opts=opts.TitleOpts(title="某商场销售情况"))
)
bar.render()
```

![image-20240717171730066](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717171730066.png)

##### 饼图

```

def pie_base() -> Pie:
    c = (
        Pie()
        .add("", [list(z) for z in zip(Faker.choose(), Faker.values())])
        .set_global_opts(title_opts=opts.TitleOpts(title="Pie-基本示例"))
        .set_series_opts(label_opts=opts.LabelOpts(formatter="{b}: {c}"))
    )
    return c

# 需要安装 snapshot_selenium
make_snapshot(driver, pie_base().render(), "pie.png")
```

![image-20240717172612582](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717172612582.png)

##### 词云图

```

words = [
    ("Sam S Club", 10000),
    ("Macys", 6181),
    ("Amy Schumer", 4386),
    ("Jurassic World", 4055),
    ("Charter Communications", 2467),
    ("Chick Fil A", 2244),
    ("Planet Fitness", 1868),
    ("Pitch Perfect", 1484),
    ("Express", 1112),
    ("Home", 865),
    ("Johnny Depp", 847),
    ("Lena Dunham", 582),
    ("Lewis Hamilton", 555),
    ("KXAN", 550),
    ("Mary Ellen Mark", 462),
    ("Farrah Abraham", 366),
    ("Rita Ora", 360),
    ("Serena Williams", 282),
    ("NCAA baseball tournament", 273),
    ("Point Break", 265),
]


def wordcloud_base() -> WordCloud:
    c = (
        WordCloud()
        .add("", words, word_size_range=[20, 100])
        .set_global_opts(title_opts=opts.TitleOpts(title="WordCloud-基本示例"))
    )
    return c

# 需要安装 snapshot_selenium
make_snapshot(driver, wordcloud_base().render(), "WordCloud.png")
```

![image-20240717172656923](C:\Users\gjy\AppData\Roaming\Typora\typora-user-images\image-20240717172656923.png)